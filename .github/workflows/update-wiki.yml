name: Publish CCTV Timelapse Web Docs To Wiki

on:
  schedule:
    # Sunday 23:30 UTC = Monday 03:00 Iran
    - cron: "30 23 * * 0"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Clone target Wiki
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/intellsoft/time-lapse-software-with-cctv-playback-film.wiki.git wiki

      - name: Fetch source documentation page
        run: |
          curl -L "https://intellsoft.ir/docs/%d8%b1%d8%a7%d9%87%d9%86%d9%85%d8%a7%db%8c-%d9%86%d8%b1%d9%85-%d8%a7%d9%81%d8%b2%d8%a7%d8%b1-%d8%aa%d8%a8%d8%af%db%8c%d9%84-%d9%81%db%8c%d9%84%d9%85-%d8%af%d9%88%d8%b1%d8%a8%db%8c%d9%86-%d9%85%d8%af/" -o web-docs.html

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4

      - name: Extract specific topics from web page
        run: |
          mkdir -p articles
          python3 - <<PYTHON
          from bs4 import BeautifulSoup

          with open("web-docs.html", encoding="utf-8") as f:
              soup = BeautifulSoup(f, "html.parser")

          # Ø¹Ù†Ø§ÙˆÛŒÙ† Ø¯Ù‚ÛŒÙ‚ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±
          target_titles = [
              "Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ÛŒÙ‡Ø§ÛŒ Ø³Ø®ØªØ§ÙØ²Ø§Ø±ÛŒ Ùˆ Ù†Ø±Ù…Ø§ÙØ²Ø§Ø±ÛŒ",
              "Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø§ Ù†Ø±Ù… Ø§ÙØ²Ø§Ø± ØªØ¨Ø¯ÛŒÙ„ ÙÛŒÙ„Ù… Ø¨Ù‡ ØªØ§ÛŒÙ… Ù„Ù¾Ø³",
              "Ø§ØªØµØ§Ù„ Ø¨Ù‡ NVR Ø§Ø² Ø±Ø§Ù‡ Ø¯ÙˆØ± Ø¨Ø§ Ø¢ÛŒÙ¾ÛŒ Ø§Ø³ØªØ§ØªÛŒÚ© Ø¨Ø§ Ù†Ø±Ù… Ø§ÙØ²Ø§Ø± ØªØ¨Ø¯ÛŒÙ„ ÙÛŒÙ„Ù… Ø¨Ù‡ ØªØ§ÛŒÙ… Ù„Ù¾Ø³",
              "Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡ NVR/DVR Ø¯Ø± Ø´Ø¨Ú©Ù‡ Ù…Ø­Ù„ÛŒ (LAN) Ø¨Ø§ Ù†Ø±Ù… Ø§ÙØ²Ø§Ø± ØªØ¨Ø¯ÛŒÙ„ ÙÛŒÙ„Ù… Ø¨Ù‡ ØªØ§ÛŒÙ… Ù„Ù¾Ø³"
          ]

          articles_data = []
          content_div = soup.find("div", class_="entry-content") or soup.find("article")

          if content_div:
              for p in content_div.find_all("p"):
                  text = p.get_text(strip=True)
                  for title in target_titles:
                      if title in text and len(text) < 150:
                          # Ø³Ø§Ø®Øª Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø§Ø² Ø¹Ù†ÙˆØ§Ù†
                          slug = title.replace(" ", "-").replace("/", "-")
                          slug = "".join(c for c in slug if c.isalnum() or c == "-")[:40].strip("-")
                          articles_data.append((slug, title))
                          break

          # Ù†ÙˆØ´ØªÙ† ÙØ§ÛŒÙ„ Ù„ÛŒØ³Øª
          with open("articles/list.txt", "w", encoding="utf-8") as out:
              for slug, title in articles_data:
                  out.write(f"{slug}\t{title}\n")
          PYTHON

      - name: Generate Wiki pages for each topic
        run: |
          while IFS=$'\t' read -r slug title; do
            file="wiki/$slug.md"
            
            if [ -f "$file" ]; then
              echo "Wiki page already exists: $title"
              continue
            fi
            
            echo "Creating Wiki page: $title"
            
            {
              echo "# $title"
              echo ""
              echo "Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø§Ø² Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø³Ù…ÛŒ Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± **CCTV Timelapse Playback** Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø§Ø³Øª."
              echo ""
              echo "---"
              echo ""
              echo "ðŸ‘‰ Ø¨Ø±Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø§Ù…Ù„ Ø±Ø§Ù‡Ù†Ù…Ø§ØŒ Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯:"
              echo ""
              echo "[Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØµÙØ­Ù‡ Ú©Ø§Ù…Ù„ Ù…Ø³ØªÙ†Ø¯Ø§Øª](https://intellsoft.ir/docs/%d8%b1%d8%a7%d9%87%d9%86%d9%85%d8%a7%db%8c-%d9%86%d8%b1%d9%85-%d8%a7%d9%81%d8%b2%d8%a7%d8%b1-%d8%aa%d8%a8%d8%af%db%8c%d9%84-%d9%81%db%8c%d9%84%d9%85-%d8%af%d9%88%d8%b1%d8%a8%db%8c%d9%86-%d9%85%d8%af/?utm_source=github_wiki&utm_medium=wiki&utm_campaign=cctv_timelapse)"
              echo ""
              echo "---"
              echo ""
              echo "ðŸ”„ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ù‡â€ŒØ·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± Ù‡ÙØªÙ‡ ØªÙˆØ³Ø· GitHub Actions Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯."
              echo ""
              echo "ðŸ“Œ **ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡:** Ø¹Ù„ÛŒ Ø¹Ø¨Ø§Ø³â€ŒÙ¾ÙˆØ±"
              
            } > "$file"
            
          done < articles/list.txt

      - name: Commit and push to Wiki
        run: |
          cd wiki
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Auto sync CCTV Timelapse web documentation to Wiki" || exit 0
          git push
